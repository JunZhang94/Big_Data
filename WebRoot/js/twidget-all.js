/*
 * TWidget JS Library
 * Author: Teon
 * Mail: TeonBox@163.com
 */
Ext.ns("Ext.twidget.layout");Ext.ns("Jinpeng.twidget");Ext.ns("Jinpeng.menu");Ext.ns("Jinpeng.system.user");Ext.twidget.layout.TTableLayout=Ext.extend(Ext.layout.TableLayout,{type:"ttable",labelSeparator:":",noLabelElementStyle:"padding-left:0;",setContainer:function(b){Ext.twidget.layout.TTableLayout.superclass.setContainer.call(this,b);b.labelAlign=b.labelAlign||this.labelAlign;if(b.labelAlign){b.addClass("x-form-label-"+b.labelAlign)}if(b.hideLabels||this.hideLabels){Ext.apply(this,{labelStyle:"display:none",elementStyle:"padding-left:0;",labelAdjust:0})}else{this.labelSeparator=Ext.isDefined(b.labelSeparator)?b.labelSeparator:this.labelSeparator;b.labelWidth=b.labelWidth||this.labelWidth||100;if(Ext.isNumber(b.labelWidth)){var c=b.labelPad||this.labelPad;var a=10;c=Ext.isNumber(c)?c:5;Ext.apply(this,{labelAdjust:b.labelWidth+c+a,labelStyle:"width:"+b.labelWidth+"px;",elementStyle:"padding-left:"+(b.labelWidth+c+a)+"px"})}if(b.labelAlign=="top"){Ext.apply(this,{labelStyle:"width:auto;",labelAdjust:0,elementStyle:"padding-left:0;"})}}},fieldTpl:(function(){var a=new Ext.Template('<div class="x-form-item {itemCls}" tabIndex="-1">','<label style="{labelStyle}" class="{labelCls}">',"{label}{labelSeparator}</label>",'<span class="{requiredStyle}">{requiredText}</span>','<div class="x-form-element" id="x-form-el-{id}" style="{elementStyle}">','</div><div class="{clearCls}"></div>',"</div>");a.disableFormats=true;return a.compile()})(),getTemplateArgs:function(d){var b=!d.fieldLabel||d.hideLabel,c=(d.itemCls||this.container.itemCls||"")+(d.hideLabel?" x-hide-label":"");if(Ext.isIE9&&Ext.isIEQuirks&&d instanceof Ext.form.TextField){c+=" x-input-wrapper"}var a=typeof d.allowBlank=="undefined"||d.allowBlank;return{id:d.id,requiredText:a?"&nbsp;":"*",requiredStyle:a?"x-form-field-notrequired":"x-form-field-required",label:d.fieldLabel,itemCls:c,clearCls:d.clearCls||"x-form-clear-left",labelCls:d.fieldLabel?"x-form-item-label":"",labelStyle:this.getLabelStyle(d.labelStyle),elementStyle:d.fieldLabel?this.elementStyle||"":this.noLabelElementStyle||"",labelSeparator:b?"":(Ext.isDefined(d.labelSeparator)?d.labelSeparator:this.labelSeparator)}},getLabelStyle:function(e){var b="",c=[this.labelStyle,e];for(var d=0,a=c.length;d<a;++d){if(c[d]){b+=c[d];if(b.substr(-1,1)!=";"){b+=";"}}}return b},renderItem:function(h,a,g){if(!this.table){this.table=g.createChild(Ext.apply({tag:"table",cls:"x-table-layout",cellspacing:0,cn:{tag:"tbody"}},this.tableAttrs),null,true)}if(h&&!h.rendered){var f=this.getNextCell(h);var e=null;if(h&&(h.isFormField||h.fieldLabel)&&h.inputType!="hidden"){var d=this.getTemplateArgs(h);h.itemCt=this.fieldTpl.append(f,d,true);if(!h.getItemCt){Ext.apply(h,{getItemCt:function(){return h.itemCt},customItemCt:true})}h.label=h.getItemCt().child("label.x-form-item-label");if(!h.rendered){h.render("x-form-el-"+h.id)}else{Ext.fly("x-form-el-"+h.id).appendChild(h.getPositionEl())}if(this.trackLabels){if(h.hidden){this.onFieldHide(h)}h.on({scope:this,show:this.onFieldShow,hide:this.onFieldHide})}this.configureItem(h)}else{h.render(f);this.configureItem(h)}}else{if(h&&!this.isValidParent(h,g)){var b=this.getNextCell(h);b.insertBefore(h.getPositionEl().dom,null);h.container=Ext.get(b);this.configureItem(h)}}},isValidParent:function(d,b){try{return d.getPositionEl().up("table",10).dom.parentNode===(b.dom||b)}catch(a){return false}},getNextCell:function(i){var a=this.getNextNonSpan(this.currentColumn,this.currentRow);var f=this.currentColumn=a[0],e=this.currentRow=a[1];for(var h=e;h<e+(i.rowspan||1);h++){if(!this.cells[h]){this.cells[h]=[]}for(var d=f;d<f+(i.colspan||1);d++){this.cells[h][d]=true}}var g=document.createElement("td");if(i.cellId){g.id=i.cellId}var b="x-table-layout-cell";if(i.cellCls){b+=" "+i.cellCls}g.className=b;if(i.colspan){g.colSpan=i.colspan}if(i.rowspan){g.rowSpan=i.rowspan}if(i.cellWidth){g.width=i.cellWidth}if(i.cellAlign){g.align=i.cellAlign}if(i.cellValign){g.valign=i.cellValign}this.getRow(e).appendChild(g);return g}});Ext.Container.LAYOUTS.ttable=Ext.twidget.layout.TTableLayout;Jinpeng.system.user.UserChooseWindow=Ext.extend(Jinpeng.widget.GeneralWindow,{title:"选择账号",width:400,height:450,layout:"border",callback:null,buttons:[{text:"确定",handler:function(a,c){var b=a.ownerCt.ownerCt;b.closeWindow(b.get(0).selections)}},{text:"取消",handler:function(a,b){a.ownerCt.ownerCt.closeWindow(false)}}],constructor:function(a){Ext.apply(this,a);this.items=[this.chooser=new Jinpeng.system.user.UserChoosePanel({margins:"5",region:"center"})];Jinpeng.system.user.UserChooseWindow.superclass.constructor.apply(this,arguments)},init:function(a){this.chooser.init(a)},closeWindow:function(a){if(typeof this.callback=="function"){this.callback({data:a})}this.close()}});Jinpeng.system.user.UserChoosePanel=Ext.extend(Ext.Panel,{layout:"border",border:false,selectedLabel:"选择的账户",selections:[],constructor:function(b){Ext.apply(this,b);var a=this;this.treeSearchPanel=new Ext.Panel({layout:"column",region:"north",autoHeight:true,border:false,bodyStyle:"padding:5px 0",defaults:{border:false,autoHeight:true},items:[{width:32,layout:"anchor",items:{xtype:"label",anchor:"-5",text:"搜索:"}},{columnWidth:1,layout:"anchor",items:{xtype:"textfield",anchor:"-5",itemId:"keyword"}},{width:70,layout:"anchor",items:{xtype:"button",anchor:"100%",bodyStyle:"margin:0",text:"搜索",handler:function(h,i){try{var f=h.ownerCt.ownerCt;var d=f.find("itemId","keyword").first();var g=d?d.getValue():null;a.searchHandler(g)}catch(j){}}}}]});this.gridSearchPanel=this.treeSearchPanel.cloneConfig();this.userGrid=new Jinpeng.widget.SimpleUserGrid({itemId:"usergrid",paging:false,rootOwner:a,region:"center",border:true,autoLoading:false,reload:function(e){var d=this.getStore();Ext.apply(d.baseParams,{"user.loginName":e});d.reload()}});var c=function(g,d){var e=Ext.isArray(g)?g:[g];for(var f=0;f<e.length;f++){e[f].iconCls=d;if(e[f].children&&e[f].children.length>0){c(e[f].children,d)}}};this.userTree=new Jinpeng.widget.OrganizationTree({itemId:"usertree",dataUrl:_app.contextPath+"/client/system/allOrgTreeMap.action",cls:"orgusertree",rootOwner:a,region:"center",border:true,showCheckbox:true,ignoreCheckStatus:true,extraUrl:_app.contextPath+"/client/system/jsonUserList.action",extraParams:{textProperty:"realname"},extraFk:"orgId",reload:function(e){var d=this.getLoader();Ext.apply(d.extraBaseParams,{"user.loginName":e});this.init()},processResponseData:function(d){c(d,"x-node-department");return d},processExtraData:function(d){c(d,"x-node-staff");return d}});this.tabPanel=new Ext.TabPanel({itemId:"tab",rootOwner:a,xtype:"tabpanel",region:"center",border:false,activeTab:0,items:[{title:"账号列表",itemId:"gridtab",autoShow:false,layout:"border",border:false,items:[this.gridSearchPanel,this.userGrid]},{title:"组织",itemId:"treetab",layout:"border",autoShow:false,border:false,items:[this.treeSearchPanel,this.userTree]}]});this.tabPanel.on("beforetabchange",function(f,i,h){var e="";if(i&&h){var d=h.get(0).get(1).get(0);var g=i.get(0).get(1).get(0);e=d.getValue();g.setValue(e)}if(i){i.get(1).reload(e)}});this.userGrid.getStore().on("load",function(j,g,m){var e=a.userGrid;var f=e.getSelectionModel();var l=a.selections;var d=[];for(var h=0;h<g.length;h++){for(var k=0;k<l.length;k++){if(g[h].get("id")==l[k].id){d.push(g[h]);break}}}f.selectRecords(d)});this.userGrid.getSelectionModel().on("selectionchange",function(g){var e=g.grid;var h=e.getStore().getRange();var d=[];var f=g.getSelections();for(var k=0;k<f.length;k++){d.push(f[k].data)}var j=[];for(var k=0;k<h.length;k++){var l=false;for(var m=0;m<d.length;m++){if(d[m].id==h[k].get("id")){l=true;break}}if(!l){j.push(h[k].data)}}a.recalculateSelections(d,j)});this.userTree.on("load",function(g){var d=a.userTree;var f=a.selections;var e=function(j){for(var h=0;h<f.length;h++){if(j.id==f[h].id){j.getUI().toggleCheck(true);break}}};g.cascade(e)});this.items=[this.tabPanel,{xtype:"form",region:"south",autoHeight:true,border:false,labelWidth:80,labelAlign:"right",margins:"5",items:this.selectedUsers=new Ext.form.TextField({fieldLabel:this.selectedLabel,itemId:"selected_users",name:"selected_users",anchor:"100%"})}];Jinpeng.system.user.UserChoosePanel.superclass.constructor.apply(this,arguments)},init:function(a){this.recalculateSelections(a,[])},searchHandler:function(a){var b=this.tabPanel.getActiveTab();var c=b.get(1);c.reload(a)},recalculateSelections:function(g,a){var b=[];var f=this.selections;for(var e=0;e<g.length;e++){var h=false;for(var d=0;d<f.length;d++){if(g[e].id==f[d].id){h=true;break}}if(!h){b.push(g[e])}}for(var d=0;d<f.length;d++){var h=false;for(var e=0;e<a.length;e++){if(a[e].id==f[d].id){h=true;break}}if(!h){b.push(f[d])}}for(var d=0;d<b.length;d++){for(var e=d+1;e<b.length;e++){if(b[d].realName>b[e].realName){var c=b[d];b[d]=b[e];b[e]=c}}}this.selections=b;this.showSelections()},showSelections:function(){var b=[];for(var a=0;a<this.selections.length;a++){b.push(this.selections[a].realName)}var c=b.join(";");this.selectedUsers.setValue(c)}});function registerStartup(a,b){if(typeof window.startupScripts=="undefined"){window.startupScripts={}}window.startupScripts[a]=b}Ext.onReady(function(){if(typeof _startup!="undefined"){if(typeof window.startupScripts!="undefined"){if(typeof window.startupScripts[_startup]=="function"){var a=window.startupScripts[_startup];a()}}}});Ext.ns("Jinpeng.system.alarmsetting");registerStartup("alarmsetting",function(){new Jinpeng.system.alarmsetting.AlarmSettingViewport({cls:"system_mod"})});Jinpeng.system.alarmsetting.AlarmSettingViewport=Ext.extend(Ext.Viewport,{id:"warnViewport",layout:"fit",constructor:function(a){Ext.apply(this,a);this.main=new Jinpeng.system.alarmsetting.SettingPanel({});this.items=[this.main];Jinpeng.system.alarmsetting.AlarmSettingViewport.superclass.constructor.apply(this,arguments)},afterRender:function(){Jinpeng.system.alarmsetting.AlarmSettingViewport.superclass.afterRender.apply(this,arguments);this.main.reload()}});Jinpeng.system.alarmsetting.SettingPanel=Ext.extend(Ext.Panel,{border:false,padding:"10",autoScroll:true,defaults:{border:false,bodyCssClass:"area1",style:"margin-bottom:10px;",padding:5},constructor:function(b){Ext.apply(this,b);var a=this;sounds=[["sound1.mp3","Sound A"],["sound2.mp3","Sound B"],["sound3.mp3","Sound C"],["sound4.mp3","Sound D"]];window.soundManager.setup({debugMode:false,url:_app.contextPath+"/content/resources/",onready:function(){a.sounds={};for(var c=0;c<sounds.length;c++){var d=sounds[c];var e=d[0];a.sounds[e]=window.soundManager.createSound({id:"sound-"+e,url:_app.contextPath+"/content/resources/"+e})}}});this.items=[{border:false,layout:"ttable",items:[{xtype:"checkbox",name:"pop_window_on_alarm",boxLabel:"告警弹出框显示",cellWidth:200},{xtype:"checkbox",name:"always_warning_flicker_on_map",boxLabel:"电子地图总是显示闪烁告警灯",cellWidth:200}]},{border:false,layout:"ttable",style:"margin-bottom:0px;",bodyCssClass:null,items:{xtype:"checkbox",name:"enable_related_notice",boxLabel:"关联卡口通知",cellWidth:200}},{border:false,layout:"ttable",items:[{xtype:"radio",name:"related_notice_mode",boxLabel:"卡口方向下一卡口",inputValue:"next",cellWidth:200},{xtype:"radio",name:"related_notice_mode",boxLabel:"卡口方向下行所有卡口",inputValue:"all",cellWidth:200}]},{border:false,layout:"ttable",style:"margin-bottom:0px;",bodyCssClass:null,items:{xtype:"checkbox",name:"enable_sound",boxLabel:"启用声音",cellWidth:200}},{xtype:"form",border:false,cls:"blue-button-ct",items:[{fieldLabel:"违法告警声音",border:false,layout:"column",items:[{xtype:"tcombo",name:"illegal_sound",selectOnFocus:true,forceSelection:true,triggerAction:"all",emptyText:"请选择",store:sounds.clone()},{xtype:"button",name:"illegal_sound_button",text:"Play",scope:a,handler:this.playIllegalSound}]},{fieldLabel:"系统告警声音",border:false,layout:"column",items:[{xtype:"tcombo",name:"warning_sound",selectOnFocus:true,forceSelection:true,triggerAction:"all",emptyText:"请选择",store:sounds.clone()},{xtype:"button",name:"warning_sound_button",text:"Play",scope:a,handler:this.playWarningSound}]}]},{border:false,cls:"blue-button-ct",bodyCssClass:null,items:[{style:"margin:auto auto;",xtype:"button",name:"ok",text:"保存",handler:this.doSaveAction}]}];Jinpeng.system.alarmsetting.SettingPanel.superclass.constructor.apply(this,arguments);this.relateComponents()},relateComponents:function(){var a=this;this.find("name","enable_sound").first().on("check",function(e,d){var f=["illegal_sound","warning_sound","illegal_sound_button","warning_sound_button"];for(var c=0;c<f.length;c++){var b=f[c];a.find("name",b).first().setDisabled(!d)}});this.find("name","enable_related_notice").first().on("check",function(c,b){Ext.each(a.find("name","related_notice_mode"),function(d){d.setDisabled(!b)})})},playSound:function(b){var a=this.sounds[b];if(a){a.play()}},playWarningSound:function(a){var b=this.find("name","warning_sound").first().getValue();this.playSound(b)},playIllegalSound:function(a){var b=this.find("name","illegal_sound").first().getValue();this.playSound(b)},reload:function(){var a=this;Ext.Ajax.request({url:_app.contextPath+"/client/system/jsonLoadAlarmSetting.action",scope:this,success:function(b,c){json=b.responseText;var d=b.responseData||Ext.decode(json);if(d&&d.success){a.init(d.data||{})}}})},init:function(e){var a=["warning_sound","illegal_sound","enable_sound","pop_window_on_alarm","always_warning_flicker_on_map","enable_related_notice","related_notice_mode"];for(var c=0;c<a.length;c++){var b=a[c];if(e&&typeof e[b]!="undefined"){this.find("name",b).first().setValue(e[b])}}var d=this.find("name","enable_related_notice").first();d.fireEvent("check",d,d.getValue());var d=this.find("name","enable_sound").first();d.fireEvent("check",d,d.getValue())},doSaveAction:function(f){var b=f.ownerCt.ownerCt;var a=["warning_sound","illegal_sound","enable_sound","pop_window_on_alarm","always_warning_flicker_on_map","enable_related_notice"];var h={};var c=b.find("name","related_notice_mode").first();h.related_notice_mode=c.getGroupValue();for(var e=0;e<a.length;e++){var d=a[e];var g=b.find("name",d).first().getValue();h[d]=g}Ext.Ajax.request({url:_app.contextPath+"/client/system/jsonUpdateAlarmSetting.action",params:h,success:function(i,j){json=i.responseText;var k=i.responseData||Ext.decode(json);if(k&&k.success){b.reload();top.Ext.Msg.show({title:"提示",msg:"操作成功",buttons:Ext.MessageBox.OK})}}})}});Ext.ns("Jinpeng.system.dictionary");registerStartup("dictionary",function(){new Jinpeng.system.dictionary.DictionaryViewport({cls:"system_mod"})});registerStartup("dictionary_category",function(){new Jinpeng.system.dictionary.DictionaryCategoryViewport({cls:"system_mod"})});registerStartup("dictionary_item",function(){new Jinpeng.system.dictionary.DictionaryItemViewport({cls:"system_mod"})});Jinpeng.system.dictionary.DictionaryViewport=Ext.extend(Ext.Viewport,{id:"dictionaryViewport",layout:"fit",constructor:function(a){Ext.apply(this,a);this.tab=new Ext.TabPanel({cls:"system_mod",defaultType:"iframepanel",activeTab:0,border:false,plain:true,items:[{title:"字典类别",defaultSrc:_app.contextPath+"/client/system/dictCat.action"},{title:"字典项目",defaultSrc:_app.contextPath+"/client/system/dictItem.action"}],listeners:{beforetabchange:function(b,e,d){if(d){var c=d.get(0);c.resetFrame()}if(e){var c=e.get(0);c.setLocation(c.defaultSrc)}}}});this.items=[this.tab];Jinpeng.system.dictionary.DictionaryViewport.superclass.constructor.apply(this,arguments)}});Jinpeng.system.dictionary.DictionaryCategoryViewport=Ext.extend(Ext.Viewport,{id:"DictionaryCategoryViewport",layout:"border",constructor:function(b){Ext.apply(this,b);var a=this;this.toolbar=new Ext.Toolbar({region:"north",border:true,cls:"toolbar",height:40,defaults:{minWidth:80},items:[{xtype:"button",text:"新增",cls:"small_btn",handler:function(c,d){a.doCreateAction()}},{style:"margin-left:5px",xtype:"button",text:"修改",cls:"small_btn",handler:function(c,d){a.doUpdateAction()}},{style:"margin-left:5px",xtype:"button",text:"删除",cls:"small_btn",handler:function(c,d){a.doDeleteAction()}}]});this.grid=new Jinpeng.system.dictionary.DictCatList({region:"center",updateHandler:function(c){a.doUpdateAction(c)},deleteHandler:function(c){a.doDeleteAction(c)}});this.items=[this.toolbar,this.grid];Jinpeng.system.dictionary.DictionaryCategoryViewport.superclass.constructor.apply(this,arguments)},reload:function(){this.grid.getStore().reload()},doCreateAction:function(){var a=this;var b=new Jinpeng.system.dictionary.DictCatModifWindow({cls:"system_mod",title:"新增字典类别",url:_app.contextPath+"/client/system/jsonCreateDictCat.action",callback:function(c){if(c=="ok"){a.reload()}}});b.init();b.show()},doUpdateAction:function(d){var b=this;if(!d){var a=this.grid.getSelectionModel().getSelections();if(a.length>1){top.Ext.Msg.show({title:"提示",msg:"只能选择一条记录",buttons:Ext.MessageBox.OK});return}else{d=a.length==1?a[0].get("id"):null}}if(d){var c=new Jinpeng.system.dictionary.DictCatModifWindow({cls:"system_mod",title:"修改字典类别",url:_app.contextPath+"/client/system/jsonUpdateDictCat.action",callback:function(e){if(e=="ok"){b.reload()}}});c.init({id:d});c.show()}else{top.Ext.Msg.show({title:"提示",msg:"请选择需要修改的记录",buttons:Ext.MessageBox.OK})}},doDeleteAction:function(e){var b=this;var d=[];if(!e){var a=this.grid.getSelectionModel().getSelections();if(a){Ext.each(a,function(f){d.push(f.get("id"))})}}else{d.push(e)}if(d&&d.length>0){var c=function(g,h,f){if(g=="ok"){Ext.Ajax.request({url:_app.contextPath+"/client/system/jsonDeleteDictCat.action",params:{ids:d},success:function(i,j){json=i.responseText;var k=i.responseData||Ext.decode(json);if(k&&k.success){b.reload()}}})}};top.Ext.MessageBox.show({buttons:{ok:"确认",cancel:"取消"},title:"确认删除",msg:"你是否确定要删除该字典类别？",modal:false,fn:c})}else{top.Ext.Msg.show({title:"提示",msg:"请选择需要删除的记录",buttons:Ext.MessageBox.OK})}}});Jinpeng.system.dictionary.DictionaryItemViewport=Ext.extend(Ext.Viewport,{id:"DictionaryCategoryViewport",layout:"border",border:false,constructor:function(b){Ext.apply(this,b);var a=this;this.toolbar=new Ext.Toolbar({region:"north",border:true,cls:"toolbar",height:40,defaults:{minWidth:80},items:[{xtype:"button",text:"新增",cls:"small_btn",handler:function(c,d){a.doCreateAction()}},{style:"margin-left:5px",xtype:"button",text:"修改",cls:"small_btn",handler:function(c,d){a.doUpdateAction()}},{style:"margin-left:5px",xtype:"button",text:"删除",cls:"small_btn",handler:function(c,d){a.doDeleteAction()}}]});this.grid=new Jinpeng.system.dictionary.DictItemList({region:"center",updateHandler:function(c){a.doUpdateAction(c)},deleteHandler:function(c){a.doDeleteAction(c)}});this.tree=new Jinpeng.system.dictionary.DictionaryCategoryTree({region:"west",width:200,title:"字典类别"});this.tree.getSelectionModel().on("selectionchange",function(e,d){var c=a.tree.getSelectedNodeId();a.grid.reload(c)});this.items=[{region:"center",layout:"border",border:false,defaults:{border:false},items:[this.tree,{region:"center",margins:"0 0 0 10",layout:"border",items:[this.toolbar,this.grid]}]}];Jinpeng.system.dictionary.DictionaryCategoryViewport.superclass.constructor.apply(this,arguments)},reload:function(){this.grid.getStore().reload()},doCreateAction:function(){var b=this;var a=b.tree.getSelectionModel().getSelectedNode().id;var c=new Jinpeng.system.dictionary.DictItemModifWindow({cls:"system_mod",title:"新增字典项目",url:_app.contextPath+"/client/system/jsonCreateDictCat.action",callback:function(d){if(d=="ok"){b.reload()}}});c.init({pid:a});c.show()},doUpdateAction:function(d){var b=this;if(!d){var a=this.grid.getSelectionModel().getSelections();if(a.length>1){top.Ext.Msg.show({title:"提示",msg:"只能选择一条记录",buttons:Ext.MessageBox.OK});return}else{d=a.length==1?a[0].get("id"):null}}if(d){var c=new Jinpeng.system.dictionary.DictItemModifWindow({cls:"system_mod",title:"修改字典项目",url:_app.contextPath+"/client/system/jsonUpdateDictItem.action",callback:function(e){if(e=="ok"){b.reload()}}});c.init({id:d});c.show()}else{top.Ext.Msg.show({title:"提示",msg:"请选择需要修改的记录",buttons:Ext.MessageBox.OK})}},doDeleteAction:function(e){var b=this;var d=[];if(!e){var a=this.grid.getSelectionModel().getSelections();if(a){Ext.each(a,function(f){d.push(f.get("id"))})}}else{d.push(e)}if(d&&d.length>0){var c=function(g,h,f){if(g=="ok"){Ext.Ajax.request({url:_app.contextPath+"/client/system/jsonDeleteDictItem.action",params:{ids:d},success:function(i,j){json=i.responseText;var k=i.responseData||Ext.decode(json);if(k&&k.success){b.reload()}}})}};top.Ext.MessageBox.show({buttons:{ok:"确认",cancel:"取消"},title:"确认删除",msg:"你是否确定要删除该字典类别？",modal:false,fn:c})}else{top.Ext.Msg.show({title:"提示",msg:"请选择需要删除的记录",buttons:Ext.MessageBox.OK})}}});Jinpeng.system.dictionary.DictCatModifWindow=Ext.extend(Jinpeng.widget.GeneralWindow,{width:300,height:150,callback:Ext.emptyFn,buttons:[{text:"确定",handler:function(a,c){var b=a.ownerCt.ownerCt;b.okHandler(a,c)}},{text:"关闭",handler:function(a,c){var b=a.ownerCt.ownerCt;b.closeHandler(a,c)}}],constructor:function(a){Ext.apply(this,a);this.fp=new top.Ext.form.FormPanel({region:"center",border:false,padding:"5",labelWidth:80,items:[{xtype:"hidden",name:"id"},{xtype:"textfield",fieldLabel:"类别编号",allowBlank:false,name:"code",anchor:"-30"},{xtype:"textarea",fieldLabel:"说明",name:"remark",anchor:"-30 -30"}]});this.items=this.fp;Jinpeng.system.dictionary.DictCatModifWindow.superclass.constructor.apply(this,arguments)},init:function(a){this.fp.getForm().load({url:_app.contextPath+"/client/system/jsonLoadDictCat.action",params:a||null})},okHandler:function(){var f="obj.";var e=this;var a=e.fp;var d=a.getForm();if(d.isValid()){var g=d.getFieldValues();var h={};for(var c in g){if(c!="-"){h[f+c]=g[c]}}var b=g.id?_app.contextPath+"/client/system/jsonUpdateDictCat.action":_app.contextPath+"/client/system/jsonCreateDictCat.action";Ext.Ajax.request({url:b,params:h,success:function(i,j){json=i.responseText;var k=i.responseData||Ext.decode(json);if(k&&k.success){if(e){e.close()}e.callback("ok")}}})}},closeHandler:function(){var a=this;a.close();a.callback("cancel")}});Jinpeng.system.dictionary.DictItemModifWindow=Ext.extend(Jinpeng.widget.GeneralWindow,{width:300,height:200,callback:Ext.emptyFn,buttons:[{text:"确定",handler:function(a,c){var b=a.ownerCt.ownerCt;b.okHandler(a,c)}},{text:"关闭",handler:function(a,c){var b=a.ownerCt.ownerCt;b.closeHandler(a,c)}}],constructor:function(a){Ext.apply(this,a);this.fp=new top.Ext.form.FormPanel({region:"center",border:false,padding:"5",labelWidth:80,items:[{xtype:"hidden",name:"id"},{xtype:"hidden",name:"pid"},{xtype:"textfield",fieldLabel:"文字",allowBlank:false,name:"text",anchor:"-30"},{xtype:"textfield",fieldLabel:"值",allowBlank:false,name:"value",anchor:"-30"},{xtype:"textarea",fieldLabel:"说明",name:"remark",anchor:"-30 -60"}]});this.items=this.fp;Jinpeng.system.dictionary.DictItemModifWindow.superclass.constructor.apply(this,arguments)},init:function(a){if(a&&a.id){this.fp.getForm().load({url:_app.contextPath+"/client/system/jsonLoadDictItem.action",params:a||null})}else{if(a&&a.pid){var b=this.fp.getForm().findField("pid");b.setValue(a.pid)}}},okHandler:function(){var f="obj.";var e=this;var a=e.fp;var d=a.getForm();if(d.isValid()){var g=d.getFieldValues();var h={};for(var c in g){if(c!="-"){h[f+c]=g[c]}}var b=g.id?_app.contextPath+"/client/system/jsonUpdateDictItem.action":_app.contextPath+"/client/system/jsonCreateDictItem.action";Ext.Ajax.request({url:b,params:h,success:function(i,j){json=i.responseText;var k=i.responseData||Ext.decode(json);if(k&&k.success){if(e){e.close()}e.callback("ok")}}})}},closeHandler:function(){var a=this;a.close();a.callback("cancel")}});Jinpeng.system.dictionary.DictItemList=Ext.extend(Jinpeng.widget.GeneralGrid,{autoExpandColumn:"remark",smtype:"checkbox",paging:true,constructor:function(b){Ext.apply(this,b);var a={icon:_app.contextPath+"/content/themes/client/blue/images/system/edit.gif",tooltip:"修改",handler:function(f,i,e){var d=f.getStore();var g=d.getAt(i);var h=g&&g.get("id")||null;if(h&&typeof f.updateHandler=="function"){f.updateHandler(h)}}};var c={icon:_app.contextPath+"/content/themes/client/blue/images/system/delete.gif",tooltip:"删除",handler:function(f,i,e){var d=f.getStore();var g=d.getAt(i);var h=g&&g.get("id")||null;if(h&&typeof f.deleteHandler=="function"){f.deleteHandler(h)}}};this.columns=[{header:"文字",name:"text",width:50},{header:"值",name:"value",width:50},{header:"描述",name:"remark"},{header:"操作",xtype:"actioncolumn",width:50,items:[a,c]}];this.store=new Ext.data.Store({url:_app.contextPath+"/client/system/jsonPagedDictItems.action",baseParams:{"page.start":0,"page.limit":this.pageSize},autoLoad:false,reader:new Jinpeng.widget.DataJsonReader({fields:["id","text","value","remark"]})});Jinpeng.system.dictionary.DictItemList.superclass.constructor.apply(this,arguments)},reload:function(a){this.store.setBaseParam("pid",a||null);this.store.load()},updateHandler:function(a){},deleteHandler:function(a){}});Jinpeng.system.dictionary.DictCatList=Ext.extend(Jinpeng.widget.GeneralGrid,{autoExpandColumn:"remark",smtype:"checkbox",paging:true,constructor:function(b){Ext.apply(this,b);var a={icon:_app.contextPath+"/content/themes/client/blue/images/system/edit.gif",tooltip:"修改",handler:function(f,i,e){var d=f.getStore();var g=d.getAt(i);var h=g&&g.get("id")||null;if(h&&typeof f.updateHandler=="function"){f.updateHandler(h)}}};var c={icon:_app.contextPath+"/content/themes/client/blue/images/system/delete.gif",tooltip:"删除",handler:function(f,i,e){var d=f.getStore();var g=d.getAt(i);var h=g&&g.get("id")||null;if(h&&typeof f.deleteHandler=="function"){f.deleteHandler(h)}}};this.columns=[{header:"类别编号",name:"code",width:50},{header:"描述",name:"remark"},{header:"操作",xtype:"actioncolumn",width:50,items:[a,c]}];this.store=new Ext.data.Store({url:_app.contextPath+"/client/system/jsonPagedDictCats.action",baseParams:{"page.start":0,"page.limit":this.pageSize},autoLoad:true,reader:new Jinpeng.widget.DataJsonReader({fields:["id","code","remark"]})});Jinpeng.system.dictionary.DictCatList.superclass.constructor.apply(this,arguments)},updateHandler:function(a){},deleteHandler:function(a){}});Jinpeng.system.dictionary.DictionaryCategoryTree=Ext.extend(Jinpeng.widget.GeneralTree,{cls:"dictcattree",border:true,dataUrl:_app.contextPath+"/client/system/jsonDictCatTreeMap.action",autoLoading:true,showCheckbox:false,listeners:{},constructor:function(a){Ext.apply(this,a);Jinpeng.system.dictionary.DictionaryCategoryTree.superclass.constructor.apply(this,arguments)}});Ext.ns("Jinpeng.system.generalsetting");registerStartup("generalsetting",function(){new Jinpeng.system.generalsetting.GeneralSettingViewport({cls:"system_mod"})});Jinpeng.system.generalsetting.GeneralSettingViewport=Ext.extend(Ext.Viewport,{layout:"fit",constructor:function(a){Ext.apply(this,a);this.main=new Jinpeng.system.generalsetting.SettingPanel({});this.items=[this.main];Jinpeng.system.generalsetting.GeneralSettingViewport.superclass.constructor.apply(this,arguments)},afterRender:function(){Jinpeng.system.generalsetting.GeneralSettingViewport.superclass.afterRender.apply(this,arguments);this.main.reload()}});Jinpeng.system.generalsetting.SettingPanel=Ext.extend(Ext.Panel,{border:false,padding:"10",autoScroll:true,defaults:{border:false,bodyCssClass:"area1",style:"margin-bottom:10px;",padding:5},constructor:function(c){Ext.apply(this,c);var b=this;this.deviceAutoCodingsOptions=[new Ext.form.Radio({name:"enable_device_auto_coding",boxLabel:"是",inputValue:"1"}),new Ext.form.Radio({name:"enable_device_auto_coding",boxLabel:"否",inputValue:"0"})];this.pictureMonitorScreenNumberOptions=[new Ext.form.Radio({name:"picture_monitor_screen_number",inputValue:1}),new Ext.form.Radio({name:"picture_monitor_screen_number",inputValue:4}),new Ext.form.Radio({name:"picture_monitor_screen_number",inputValue:9}),new Ext.form.Radio({name:"picture_monitor_screen_number",inputValue:16})];var a=new Ext.Panel({title:"设备自动编号",layout:"ttable",labelWidth:120,labelAlign:"right",items:[this.deviceAutoCoding=new Ext.Panel({fieldLabel:"启用设备自动编号",border:false,cellWidth:300,layout:"ttable",defaults:{border:false,cellWidth:70},items:[{items:this.deviceAutoCodingsOptions[0]},{items:this.deviceAutoCodingsOptions[1]}]}),this.deviceCodingStartNumber=new Ext.form.TextField({name:"device_coding_start_number",fieldLabel:"起始编号",cellWidth:300})]});var h=new Ext.Panel({title:"图片监控默认分屏",layout:"ttable",defaults:{border:false,cellWidth:50},items:[{cellAlign:"right",items:this.pictureMonitorScreenNumberOptions[0]},{cellAlign:"left",html:'<img src="'+_app.contextPath+'/content/themes/client/blue/images/system/screen1.jpg" width="24" height="24">'},{cellAlign:"right",items:this.pictureMonitorScreenNumberOptions[1]},{cellAlign:"left",html:'<img src="'+_app.contextPath+'/content/themes/client/blue/images/system/screen4.jpg" width="24" height="24">'},{cellAlign:"right",items:this.pictureMonitorScreenNumberOptions[2]},{cellAlign:"left",html:'<img src="'+_app.contextPath+'/content/themes/client/blue/images/system/screen9.jpg" width="24" height="24">'},{cellAlign:"right",items:this.pictureMonitorScreenNumberOptions[3]},{cellAlign:"left",html:'<img src="'+_app.contextPath+'/content/themes/client/blue/images/system/screen16.jpg" width="24" height="24">'}]});var g=new Ext.Panel({title:"数据信息最大保留时间",layout:"ttable",labelWidth:140,labelAlign:"right",items:[this.alarmMessageRetentionTime=new Ext.ux.form.SpinnerField({name:"alarm_message_retention_time",fieldLabel:"告警信息最大保留时间",width:45,cellWidth:210,minValue:0,maxValue:100,allowDecimals:false,incrementValue:1,accelerate:true}),{xtype:"label",cellWidth:200,text:"月"},this.logMessageRetentionTime=new Ext.ux.form.SpinnerField({name:"log_message_retention_time",fieldLabel:"日志信息最大保留时间",width:45,cellWidth:210,minValue:0,maxValue:100,allowDecimals:false,incrementValue:1,accelerate:true}),{xtype:"label",text:"月"}]});var f=new Ext.Panel({title:"动态域名解释器（DDNS)",layout:"ttable",labelWidth:80,labelAlign:"right",layoutConfig:{columns:4},defaults:{cellWidth:250},items:[this.ddnsAddress1=new Ext.form.TextField({name:"ddsn_address1",fieldLabel:"DDSN1",regex:/((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)/,regexText:"地址格式错误"}),this.ddnsPort1=new Ext.form.TextField({name:"ddsn_port1",fieldLabel:"端口"}),this.ddnsAddress2=new Ext.form.TextField({name:"ddsn_address2",fieldLabel:"DDSN2",regex:/((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)/,regexText:"地址格式错误"}),this.ddnsPort2=new Ext.form.TextField({name:"ddsn_port2",fieldLabel:"端口"}),this.ddnsAddress3=new Ext.form.TextField({name:"ddsn_address3",fieldLabel:"DDSN3",regex:/((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)/,regexText:"地址格式错误"}),this.ddnsPort3=new Ext.form.TextField({name:"ddsn_port3",fieldLabel:"端口"}),this.ddnsAddress4=new Ext.form.TextField({name:"ddsn_address4",fieldLabel:"DDSN4",regex:/((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)/,regexText:"地址格式错误"}),this.ddnsPort4=new Ext.form.TextField({name:"ddsn_port4",fieldLabel:"端口"})]});var e=new Ext.Panel({title:"WEB服务器IP地址",layout:"ttable",labelWidth:120,labelAlign:"right",items:[this.internalWebServerAddress=new Ext.form.TextField({name:"internal_web_server_address",fieldLabel:"内部IP地址",cellWidth:300,regex:/((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)/,regexText:"IP地址格式错误"}),this.externalWebServerAddress=new Ext.form.TextField({name:"external_web_server_address",fieldLabel:"外部IP地址",cellWidth:300,regex:/((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)/,regexText:"IP地址格式错误"})]});var d=new Ext.Panel({title:"网管服务器",layout:"ttable",labelWidth:120,labelAlign:"right",items:[this.webmasterServerAddress=new Ext.form.TextField({name:"webmaster_server_address",fieldLabel:"网管服务器IP地址",cellWidth:300}),this.webmasterServerPort=new Ext.form.TextField({name:"webmaster_server_port",fieldLabel:"网管服务器端口",cellWidth:300})]});this.items=[a,h,g,f,e,d,{border:false,cls:"blue-button-ct",bodyCssClass:null,items:[{style:"margin:auto auto;",xtype:"button",name:"ok",text:"保存",handler:this.doSaveAction}]}];Jinpeng.system.generalsetting.SettingPanel.superclass.constructor.apply(this,arguments);this.relateComponents()},relateComponents:function(){var a=this;this.find("name","enable_device_auto_coding").first().on("check",function(d,c){var b=a.find("name","device_coding_start_number");Ext.each(b,function(e){e.setDisabled(!c)})})},reload:function(){var a=this;Ext.Ajax.request({url:_app.contextPath+"/client/system/jsonLoadGeneralSetting.action",scope:this,success:function(b,c){json=b.responseText;var d=b.responseData||Ext.decode(json);if(d&&d.success){a.init(d.data||{})}}})},init:function(f){var a=["enable_device_auto_coding","device_coding_start_number","picture_monitor_screen_number","alarm_message_retention_time","log_message_retention_time","ddsn_address1","ddsn_port1","ddsn_address2","ddsn_port2","ddsn_address3","ddsn_port3","ddsn_address4","ddsn_port4","internal_web_server_address","external_web_server_address","webmaster_server_address","webmaster_server_port"];for(var d=0;d<a.length;d++){var c=a[d];if(f&&typeof f[c]!="undefined"){var b=this.find("name",c);if(b){b.first().setValue(f[c])}}}var e=this.find("name","enable_device_auto_coding").first();e.fireEvent("check",e,e.getValue())},doSaveAction:function(e){var b=e.ownerCt.ownerCt;var a=["device_coding_start_number","alarm_message_retention_time","log_message_retention_time","ddsn_address1","ddsn_port1","ddsn_address2","ddsn_port2","ddsn_address3","ddsn_port3","ddsn_address4","ddsn_port4","internal_web_server_address","external_web_server_address","webmaster_server_address","webmaster_server_port"];var g={enable_device_auto_coding:b.deviceAutoCodingsOptions[0].getGroupValue(),picture_monitor_screen_number:b.pictureMonitorScreenNumberOptions[0].getGroupValue()};for(var d=0;d<a.length;d++){var c=a[d];var f=b.find("name",c).first().getValue();g[c]=f}Ext.Ajax.request({url:_app.contextPath+"/client/system/jsonUpdateGeneralSetting.action",params:g,success:function(h,i){json=h.responseText;var j=h.responseData||Ext.decode(json);if(j&&j.success){b.reload();top.Ext.Msg.show({title:"提示",msg:"操作成功",buttons:Ext.MessageBox.OK})}}})}});Ext.ns("Jinpeng.system.org");registerStartup("organization",function(){new Jinpeng.system.org.OrganizationViewPort({cls:"system_mod"})});Jinpeng.system.org.OrganizationViewPort=Ext.extend(Ext.Viewport,{id:"organizationViewport",layout:"fit",constructor:function(b){var a=this;Ext.apply(this,b);this.tree=new Jinpeng.widget.OrganizationTree({region:"west",title:"组织结构",width:200,margins:"0 5 0 0",autoLoading:true,showCheckbox:false});this.tree.getSelectionModel().on("selectionchange",function(e,d){var c=a.tree.getSelectedNodeId();a.grid.reload()});this.searchbar=new Ext.Panel({border:false,layout:"ttable",cls:"filter_area",labelWidth:70,labelAlign:"right",items:[{xtype:"textfield",fieldLabel:"关键字",name:"keyword",width:156},{style:"margin-left:5px",xtype:"button",minWidth:80,text:"查询",cls:"small_btn",handler:function(c,d){a.grid.reload()}}],getKeyword:function(){return this.find("name","keyword").first().getValue()}});this.toolbar=new Ext.Toolbar({border:false,cls:"toolbar",defaults:{minWidth:80},items:[{xtype:"button",text:"新增",cls:"small_btn",handler:function(c,d){a.doCreateAction()}},{style:"margin-left:5px",xtype:"button",text:"修改",cls:"small_btn",handler:function(c,d){a.doUpdateAction()}},{style:"margin-left:5px",xtype:"button",text:"删除",cls:"small_btn",handler:function(c,d){a.doDeleteAction()}}]});this.grid=new Jinpeng.system.org.OrganizationGrid({region:"center",height:300});this.main=new Ext.Panel({layout:"border",border:false,cls:"system_mod",items:[this.tree,{region:"center",border:false,layout:"border",items:[{region:"north",border:false,autoHeight:true,items:[this.searchbar,this.toolbar]},this.grid]}]});this.items=[this.main];Jinpeng.system.org.OrganizationViewPort.superclass.constructor.apply(this,arguments)},refresh:function(){this.tree.reload()},doCreateAction:function(){var b=this.tree.getSelectedNodeId();var a=new Jinpeng.system.org.OrganizationModificationWindow({cls:"system_mod",title:"新增组织结构",callback:function(d){if(d=="ok"){var c=Ext.getCmp("organizationViewport");c.refresh()}}});a.init({orgId:b});a.show()},doUpdateAction:function(d){if(!d){var a=this.grid.getSelectionModel().getSelections();if(a.length>1){top.Ext.Msg.show({title:"提示",msg:"只能选择一条记录",buttons:Ext.MessageBox.OK});return}else{d=a.length==1?a[0].get("id"):null}}if(d){var c=this.tree.getSelectedNodeId();var b=new Jinpeng.system.org.OrganizationModificationWindow({cls:"system_mod",title:"修改组织结构",callback:function(f){if(f=="ok"){var e=Ext.getCmp("organizationViewport");e.refresh()}}});b.init({id:d,orgId:c});b.show()}else{top.Ext.Msg.show({title:"提示",msg:"请选择需要修改的记录",buttons:Ext.MessageBox.OK})}},doDeleteAction:function(c){var b=[];if(!c){var a=this.grid.getSelectionModel().getSelections();if(a){Ext.each(a,function(d){b.push(d.get("id"))})}}else{b.push(c)}if(b&&b.length>0){top.Ext.MessageBox.show({buttons:{ok:"确认",cancel:"取消"},title:"确认删除",msg:"你是否确定要删除该组织？",modal:false,fn:function(e,f,d){if(e=="ok"){Ext.Ajax.request({url:_app.contextPath+"/client/system/deleteOrg.action",params:{ids:b},success:function(h,i){json=h.responseText;var k=h.responseData||Ext.decode(json);if(k&&k.success){var g=Ext.getCmp("organizationViewport");g.refresh();try{top.broadcastEvent("delOrgEvent",function(){},{orgId:c})}catch(j){}}}})}}})}else{top.Ext.Msg.show({title:"提示",msg:"请选择需要删除的记录",buttons:Ext.MessageBox.OK})}}});Jinpeng.system.org.OrganizationGrid=Ext.extend(Jinpeng.widget.GeneralGrid,{paging:true,constructor:function(a){Ext.apply(this,a);this.store=new Ext.data.Store({pageSize:this.pageSize,remoteSort:true,autoLoad:this.autoLoading,url:_app.contextPath+"/client/system/orgPage.action",reader:new Ext.data.JsonReader({fields:["id","no","orgName","coding","enCode","parentOrgName","mem"],idProperty:"id",root:"result",totalProperty:"totalCount"}),listeners:{beforeload:function(e,f){var d=Ext.getCmp("organizationViewport");var c=d.searchbar.getKeyword();var b=d.tree.getSelectedNodeId();if(!f.params){f.params={}}Ext.apply(f.params,{parentId:b,keyword:c});Ext.applyIf(f.params,{"page.start":0,"page.limit":this.pageSize})}}});this.columns=[{header:"组织名称",dataIndex:"orgName",width:100},{header:"组织编号别名",dataIndex:"enCode",width:100},{header:"组织编号",dataIndex:"coding",width:100},{header:"上级组织",dataIndex:"parentOrgName",width:100},{header:"描述",dataIndex:"mem",width:100},{header:"操作",xtype:"actioncolumn",width:100,items:[{icon:_app.contextPath+"/content/themes/client/blue/images/system/edit.gif",tooltip:"修改",handler:function(d,g,c){var e=d.getStore().getAt(g);var f=e&&e.get("id")||null;var b=Ext.getCmp("organizationViewport");if(f){b.doUpdateAction(f)}}},{icon:_app.contextPath+"/content/themes/client/blue/images/system/delete.gif",tooltip:"删除",handler:function(d,g,c){var e=d.getStore().getAt(g);var f=e&&e.get("id")||null;var b=Ext.getCmp("organizationViewport");if(f){b.doDeleteAction(f)}}}]}];Jinpeng.system.org.OrganizationGrid.superclass.constructor.apply(this,arguments)}});Jinpeng.system.org.OrganizationModificationWindow=Ext.extend(Jinpeng.widget.GeneralWindow,{width:400,height:200,constructor:function(a){Ext.apply(this,a);var b=new top.Ext.data.JsonStore({url:_app.contextPath+"/client/system/allOrgsInCombo.action",baseParams:this.baseParams,root:"data",idProperty:"id",totalProperty:"totalCount",autoLoad:false,fields:["id","text"]});this.fp=new top.Ext.form.FormPanel({region:"center",border:false,url:this.url,margins:"5",defaults:{xtype:"textfield"},items:[{name:"id",xtype:"hidden"},{fieldLabel:"组织名称",name:"orgName",anchor:"-30",allowBlank:false,blankText:"请填写组织名称",emptyText:"请填写组织名称",regex:/^.{2,100}$/,regexText:"组织名称限定为2~100个字符"},{fieldLabel:"组织编号别名",name:"enCode",anchor:"-30",regex:/^.{2,32}$/,regexText:"组织编号别名限定为2~32个字符"},{xtype:"tcombo",triggerAction:"all",store:b,mode:"local",fieldLabel:"上级组织",name:"pid",anchor:"-30",valueField:"id",displayField:"text",allowBlank:false,blankText:"请选择上级组织",emptyText:"请选择上级组织"},{xtype:"textarea",fieldLabel:"描述",name:"mem",anchor:"-30 -80",regex:/^.{0,400}$/,regexText:"描述限定为400个字符"}]});this.buttons=[{text:"确定",handler:this.okHandler},{text:"关闭",handler:this.closeHandler}];this.items=this.fp;Jinpeng.system.org.OrganizationModificationWindow.superclass.constructor.apply(this,arguments)},init:function(b){var d=this;var c=this.fp.getForm();var e=c.findField("pid");var f=b.id||null;var a=b.orgId||null;e.getStore().load({callback:function(h,g,i){if(f){c.load({url:_app.contextPath+"/client/system/loadOrg.action",params:{id:f}})}else{if(a){e.setValue(a)}}}})},okHandler:function(){var f="org.";var e=this.ownerCt.ownerCt;var a=e.fp;var d=a.getForm();if(d.isValid()){var g=d.getFieldValues();var h={};for(var c in g){h[f+c]=g[c]}var b=g.id?_app.contextPath+"/client/system/updateOrg.action":_app.contextPath+"/client/system/createOrg.action";Ext.Ajax.request({url:b,params:h,success:function(i,j){json=i.responseText;var l=i.responseData||Ext.decode(json);if(l&&l.success){if(e){e.close()}try{if(!g.id){top.broadcastEvent("addOrgEvent",function(){},{orgId:l.data})}else{top.broadcastEvent("modifyOrgEvent",function(){},{orgId:l.data})}}catch(k){}e.callback("ok")}}})}},closeHandler:function(){var a=this.ownerCt.ownerCt;if(a){a.close()}}});Ext.ns("Jinpeng.system.permgroup");registerStartup("permgroup",function(){new Jinpeng.system.permgroup.PermGroupViewPort({cls:"system_mod"})});Jinpeng.system.permgroup.PermGroupViewPort=Ext.extend(Ext.Viewport,{id:"permGroupViewport",layout:"fit",constructor:function(a){Ext.apply(this,a);this.tab=new Jinpeng.system.permgroup.PermGroupTabPanel({id:"system.permpanel",cls:"system_mod"});this.items=[this.tab];Jinpeng.system.permgroup.PermGroupViewPort.superclass.constructor.apply(this,arguments)},doCreateAction:function(a){var b=new Jinpeng.system.permgroup.PermGroupModificationWindow({cls:"system_mod",type:a,title:"新增权限集",callback:function(c){if(c=="ok"){Ext.getCmp("system.permpanel").reload()}}});b.init();b.show()},doUpdateAction:function(c,e){if(!e){var b=this.tab.getActiveGrid();var a=b.getSelectionModel().getSelections();if(a.length>1){top.Ext.Msg.show({title:"提示",msg:"只能选择一条记录",buttons:Ext.MessageBox.OK});return}else{e=a.length==1?a[0].get("id"):null}}if(e){var d=new Jinpeng.system.permgroup.PermGroupModificationWindow({cls:"system_mod",type:c,title:"修改权限集",callback:function(f){if(f=="ok"){Ext.getCmp("system.permpanel").reload()}}});d.init({id:e});d.show()}else{top.Ext.Msg.show({title:"提示",msg:"请选择需要修改的记录",buttons:Ext.MessageBox.OK})}},doDeleteAction:function(e,f){var d=[];if(!f){var c=this.tab.getActiveGrid();var a=c.getSelectionModel().getSelections();if(a){Ext.each(a,function(g){d.push(g.get("id"))})}}else{d.push(f)}if(d&&d.length>0){var b=null;if(e=="func"){b=_app.contextPath+"/client/system/jsonDeleteRole.action"}else{if(e=="org"){b=_app.contextPath+"/client/system/jsonDeleteOrgRole.action"}}top.Ext.MessageBox.show({buttons:{ok:"确认",cancel:"取消"},title:"确认删除",msg:"你是否确定要删除该用户？",modal:false,fn:function(h,i,g){if(h=="ok"){Ext.Ajax.request({url:b,params:{ids:d},success:function(j,k){json=j.responseText;var l=j.responseData||Ext.decode(json);if(l&&l.success){Ext.getCmp("system.permpanel").reload()}}})}}})}else{top.Ext.Msg.show({title:"提示",msg:"请选择需要删除的记录",buttons:Ext.MessageBox.OK})}}});Jinpeng.system.permgroup.PermGroupTabPanel=Ext.extend(Ext.TabPanel,{activeTab:0,border:false,plain:true,pageSize:10,padding:5,listeners:{beforetabchange:function(a,d,c){if(d){var b=d.getItemId();if(b=="func"){this.funcList.reload()}else{if(b=="org"){this.orgList.reload()}}}}},constructor:function(a){Ext.apply(this,a);this.funcList=new Jinpeng.system.permgroup.PermGroupList({id:"system.funcPGList",type:"func",pageSize:this.pageSize,updateHandler:function(c){var b=Ext.getCmp("permGroupViewport");b.doUpdateAction(this.type,c)},deleteHandler:function(c){var b=Ext.getCmp("permGroupViewport");b.doDeleteAction(this.type,c)},viewAssignedPermHandler:function(d,f,c){var b=d.getStore().getAt(f).get("name");var e=d.getStore().getAt(f).get("id");new Jinpeng.system.permgroup.ViewAssignedPermGroupWindow({dataUrl:_app.contextPath+"/client/system/jsonAllModuleTreeMap.action",baseParams:{roleId:e},title:"查看拥有权限"}).show()},viewAssignedUserHandler:function(d,f,c){var b=d.getStore().getAt(f).get("name");var e=d.getStore().getAt(f).get("id");new Jinpeng.system.permgroup.ViewAssignedUserWindow({dataUrl:_app.contextPath+"/client/system/jsonLoadRole.action",baseParams:{id:e},title:"查看授权用户"}).show()},pageSize:this.pageSize});this.funcTab=new Ext.Panel({itemId:"func",title:"功能权限集",autoHeight:true,autoScroll:true,items:[{border:false,xtype:"toolbar",cls:"toolbar",defaults:{minWidth:80},items:[{xtype:"button",text:"新增",cls:"small_btn",handler:function(c,d){var b=Ext.getCmp("permGroupViewport");b.doCreateAction("func")}},{style:"margin-left:5px",xtype:"button",text:"修改",cls:"small_btn",handler:function(c,d){var b=Ext.getCmp("permGroupViewport");b.doUpdateAction("func")}},{style:"margin-left:5px",xtype:"button",text:"删除",cls:"small_btn",handler:function(c,d){var b=Ext.getCmp("permGroupViewport");b.doDeleteAction("func")}}]},this.funcList]});this.orgList=new Jinpeng.system.permgroup.PermGroupList({id:"system.orgPGList",type:"org",pageSize:this.pageSize,updateHandler:function(c){var b=Ext.getCmp("permGroupViewport");b.doUpdateAction(this.type,c)},deleteHandler:function(c){var b=Ext.getCmp("permGroupViewport");b.doDeleteAction(this.type,c)},viewAssignedPermHandler:function(d,f,c){var b=d.getStore().getAt(f).get("name");var e=d.getStore().getAt(f).get("id");new Jinpeng.system.permgroup.ViewAssignedPermGroupWindow({dataUrl:_app.contextPath+"/client/system/allOrgTreeMap.action",baseParams:{orgRoleId:e},title:"查看拥有权限"}).show()},viewAssignedUserHandler:function(d,f,c){var b=d.getStore().getAt(f).get("name");var e=d.getStore().getAt(f).get("id");new Jinpeng.system.permgroup.ViewAssignedUserWindow({dataUrl:_app.contextPath+"/client/system/jsonLoadOrgRole.action",baseParams:{id:e},title:"查看授权用户"}).show()}});this.orgTab=new Ext.Panel({itemId:"org",title:"组织权限集",autoHeight:true,autoScroll:true,items:[{border:false,xtype:"toolbar",cls:"toolbar",defaults:{minWidth:80},items:[{xtype:"button",text:"新增",cls:"small_btn",handler:function(c,d){var b=Ext.getCmp("permGroupViewport");b.doCreateAction("org")}},{style:"margin-left:5px",xtype:"button",text:"修改",cls:"small_btn",handler:function(c,d){var b=Ext.getCmp("permGroupViewport");b.doUpdateAction("org")}},{style:"margin-left:5px",xtype:"button",text:"删除",cls:"small_btn",handler:function(c,d){var b=Ext.getCmp("permGroupViewport");b.doDeleteAction("org")}}]},this.orgList]});this.items=[this.funcTab,this.orgTab];Jinpeng.system.permgroup.PermGroupTabPanel.superclass.constructor.apply(this,arguments)},reload:function(){var a=this.getActiveTab().getItemId();if(a=="func"){this.funcList.getStore().reload()}else{if(a=="org"){this.orgList.getStore().reload()}}},getActiveGrid:function(){var a=this.getActiveTab().getItemId();if(a=="func"){return this.funcList}else{if(a=="org"){return this.orgList}else{return null}}}});Jinpeng.system.permgroup.ViewAssignedUserWindow=Ext.extend(Jinpeng.widget.GeneralWindow,{width:400,height:300,baseParams:{},closeHandler:function(){this.close()},constructor:function(a){Ext.apply(this,a);this.grid=new top.Jinpeng.widget.SimpleUserGrid({anchor:"100% 100%",store:new top.Ext.data.JsonStore({url:this.dataUrl,baseParams:this.baseParams,root:"data.users",idProperty:"id",totalProperty:"totalCount",autoLoad:true,fields:["id","loginName","realName","orgName"]}),paging:false,init:function(c){var b=this.getStore();b.loadData({data:c})}});this.items={xtype:"fieldset",title:"所分配的用户",region:"center",border:true,margins:"5",items:[this.grid]};this.buttons=[{text:"关闭",handler:function(b,d){var c=b.ownerCt.ownerCt;c.closeHandler(b,d)}}];Jinpeng.system.permgroup.ViewAssignedUserWindow.superclass.constructor.apply(this,arguments)}});Jinpeng.system.permgroup.PermGroupModificationWindow=Ext.extend(Jinpeng.widget.GeneralWindow,{width:400,height:400,callback:Ext.emptyFn,buttons:[{text:"确定",handler:function(a,c){var b=a.ownerCt.ownerCt;b.okHandler(a,c)}},{text:"关闭",handler:function(a,c){var b=a.ownerCt.ownerCt;b.closeHandler(a,c)}}],constructor:function(a){Ext.apply(this,a);var b=this;this.userGrid=new top.Jinpeng.widget.SimpleUserGrid({region:"center",smtype:"row",store:new Ext.data.JsonStore({root:"data",idProperty:"id",totalProperty:"totalCount",autoLoad:false,fields:["id","loginName","realName","orgName"]}),paging:false,init:function(d){var c=this.getStore();c.loadData({data:d})}});if(this.type=="func"){this.mainComponent=this.moduleTree=new top.Jinpeng.widget.GeneralTree({region:"center",dataUrl:_app.contextPath+"/client/system/jsonAllModuleTreeMap.action",processResponseData:function(g){try{var c=g?(Ext.isArray(g)?g:[g]):[];for(var d=0;d<c.length;d++){var f=c[d];if(f.readonly){f.uiProvider=Jinpeng.widget.TTreeNodeUI}}return g}catch(h){Ext.debug("Exception occured : %o",h);return[]}}})}else{if(this.type=="org"){this.mainComponent=this.orgTree=new top.Jinpeng.widget.OrganizationTree({showCheckbox:true,dataUrl:_app.contextPath+"/client/system/allOrgTreeMap.action",region:"center"})}}this.tab=new top.Ext.TabPanel({region:"center",border:true,margins:"5",activeTab:0,items:[{title:"拥有权限",layout:"border",border:false,items:[this.mainComponent]},{title:"授权账户",layout:"border",border:false,items:[{region:"north",xtype:"toolbar",border:false,autoHeight:true,margins:"5",items:["->",{owner:this,xtype:"button",text:"选择用户",handler:this.chooseUserHandler}]},this.userGrid]}]});this.fp=new top.Ext.form.FormPanel({xtype:"form",region:"north",border:false,autoHeight:"auto",margins:"5",labelAlign:"right",labelWidth:100,items:[{xtype:"hidden",name:"id"},{fieldLabel:"功能权限名称",xtype:"textfield",name:"name",anchor:"-30",allowBlank:false,blankText:"请填写功能权限名称",emptyText:"请填写功能权限名称",regex:/^.{2,100}$/,regexText:"功能权限名称限定为2~100个字符"},{fieldLabel:"描述",xtype:"textarea",name:"remark",height:50,anchor:"-30",regex:/^.{0,500}$/,regexText:"功能权限名称限定为500个字符"}]});this.items=[this.fp,this.tab];Jinpeng.system.permgroup.PermGroupModificationWindow.superclass.constructor.apply(this,arguments)},init:function(c){var b=this;var d=b.mainComponent;if(c){var a=null;if(b.type=="func"){a=_app.contextPath+"/client/system/jsonLoadRole.action"}else{if(b.type=="org"){a=_app.contextPath+"/client/system/jsonLoadOrgRole.action"}}this.fp.getForm().load({url:a,params:c,success:function(f,h){if(h&&h.result&&h.result.data){var g=h.result.data;var i=g.users||[];b.userGrid.init(i);var e=null;if(b.type=="func"){e=g.modules}else{if(b.type=="org"){e=g.organizations}}d.init(e)}}})}else{d.reload()}},chooseUserHandler:function(d,g){var f=d.owner;var b=f.userGrid.getStore();var a=b.getRange();var h=[];if(a){for(var c=0;c<a.length;c++){h.push(a[c].data)}}var e=new top.Jinpeng.system.user.UserChooseWindow({cls:"system_mod",modal:false,callback:function(i){if(i.data){var k=f.userGrid;var j=k.getStore();j.loadData(i)}}});e.init(h);e.show()},okHandler:function(){var l=this;var e=this.fp;var d=e.getForm();var g={};var f=l.userGrid.getStore().getRange();var k=[];for(var h=0;h<f.length;h++){k.push(f[h].get("id"))}if(k.length>0){g.uids=k}if(l.moduleTree){mids=l.moduleTree.getChecked("id");if(mids.length>0){g.mids=mids}}if(l.orgTree){oids=l.orgTree.getChecked("id");if(oids.length>0){g.oids=oids}}var c=d.getFieldValues();if(d.isValid()){var c=d.getFieldValues();var j="";if(this.type=="func"){j="role."}else{if(this.type=="org"){j="orgRole."}}for(var h in c){g[j+h]=c[h]}var a=true;if(this.type=="func"&&(!g.mids||g.mids.length==0)){a=false;top.Ext.Msg.show({title:"提示",msg:"请至少选择一个模块",buttons:Ext.MessageBox.OK})}if(this.type=="org"&&(!g.oids||g.oids.length==0)){a=false;top.Ext.Msg.show({title:"提示",msg:"请至少选择一个组织",buttons:Ext.MessageBox.OK})}if(a){var b=null;if(this.type=="func"){if(c.id){b=_app.contextPath+"/client/system/jsonUpdateRole.action"}else{b=b=_app.contextPath+"/client/system/jsonCreateRole.action"}}else{if(c.id){b=_app.contextPath+"/client/system/jsonUpdateOrgRole.action"}else{b=b=_app.contextPath+"/client/system/jsonCreateOrgRole.action"}}Ext.Ajax.request({url:b,params:g,success:function(i,m){json=i.responseText;var n=i.responseData||Ext.decode(json);if(n&&n.success){if(l){l.close()}l.callback("ok")}}})}}},closeHandler:function(){var a=this;a.close();a.callback("cancel")}});Jinpeng.system.permgroup.ViewAssignedPermGroupWindow=Ext.extend(Jinpeng.widget.GeneralWindow,{width:400,height:400,closeHandler:function(){this.close()},constructor:function(a){Ext.apply(this,a);this.tree=new top.Jinpeng.widget.GeneralTree({dataUrl:this.dataUrl,showCheckbox:false,autoLoading:true,baseParams:this.baseParams,anchor:"100% 100%"});this.items={xtype:"fieldset",title:"所拥有的权限",region:"center",border:true,margins:"5",items:[this.tree]};this.buttons=[{text:"关闭",handler:function(b,d){var c=b.ownerCt.ownerCt;c.closeHandler(b,d)}}];Jinpeng.system.permgroup.ViewAssignedPermGroupWindow.superclass.constructor.apply(this,arguments)}});Jinpeng.system.permgroup.PermGroupList=Ext.extend(Jinpeng.widget.GeneralGrid,{type:null,height:320,autoExpandColumn:"remark",smtype:"checkbox",updateHandler:Ext.emptyFn,deleteHandler:Ext.emptyFn,viewAssignedPermHandler:Ext.emptyFn,viewAssignedUserHandler:Ext.emptyFn,constructor:function(c){Ext.apply(this,c);var b={icon:_app.contextPath+"/content/themes/client/blue/images/system/edit.gif",tooltip:"修改",handler:function(g,j,f){var e=g.getStore();var h=e.getAt(j);var i=h&&h.get("id")||null;if(i&&typeof g.updateHandler=="function"){g.updateHandler(i)}}};var d={icon:_app.contextPath+"/content/themes/client/blue/images/system/delete.gif",tooltip:"删除",handler:function(g,j,f){var e=g.getStore();var h=e.getAt(j);var i=h&&h.get("id")||null;if(i&&typeof g.deleteHandler=="function"){g.deleteHandler(i)}}};this.columns=[{header:"名称",name:"name",width:100},{header:"描述",name:"remark"},{header:"拥有权限",dataIndex:"assignperm",width:100,renderer:function(){return"查看"}},{header:"授权用户",dataIndex:"assignuser",width:100,renderer:function(){return"查看"}},{header:"操作",xtype:"actioncolumn",width:100,items:[b,d]}];var a=null;if(this.type=="func"){a=_app.contextPath+"/client/system/jsonRolePage.action"}else{if(this.type=="org"){a=_app.contextPath+"/client/system/jsonOrgRolePage.action"}}this.store=new Ext.data.JsonStore({url:a,baseParams:{start:0,limit:this.pageSize,type:this.type},root:"result",idProperty:"id",totalProperty:"totalCount",autoLoad:false,fields:["id","name","remark"]});Jinpeng.system.permgroup.PermGroupList.superclass.constructor.apply(this,arguments)},listeners:{cellclick:function(b,g,c,d){var a=b.getStore().getAt(g);var f=b.getColumnModel().getDataIndex(c);if(f=="assignperm"){if(typeof this.viewAssignedPermHandler=="function"){this.viewAssignedPermHandler(b,g,c)}}else{if(f=="assignuser"){if(typeof this.viewAssignedUserHandler=="function"){this.viewAssignedUserHandler(b,g,c)}}}}}});Ext.ns("Jinpeng.system.server");registerStartup("server",function(){new Jinpeng.system.server.ServerViewport({cls:"system_mod"})});Jinpeng.system.server.ServerGrid=Ext.extend(Ext.grid.GridPanel,{pageSize:10,paging:true,autoLoading:true,loadMask:false,constructor:function(c){Ext.apply(this,c);this.sm=new Ext.grid.CheckboxSelectionModel({});this.columns=[this.sm,{header:"服务名称",dataIndex:"title",width:100},{header:"服务编号",dataIndex:"serverId",width:100},{header:"服务类型",dataIndex:"typeText",width:100},{header:"所在目录",dataIndex:"currPath",width:100},{header:"IP地址",dataIndex:"ipAddress",width:100},{header:"端口",dataIndex:"port",width:100},{header:"操作",xtype:"actioncolumn",width:100,items:[{icon:_app.contextPath+"/content/themes/client/blue/images/system/edit.gif",tooltip:"修改",handler:function(f,i,e){var g=f.getStore().getAt(i);var h=g&&g.get("id")||null;var d=Ext.getCmp("serverViewport");if(h){d.doUpdateAction(h)}}},{icon:_app.contextPath+"/content/themes/client/blue/images/system/delete.gif",tooltip:"删除",handler:function(f,i,e){var g=f.getStore().getAt(i);var h=g&&g.get("id")||null;var d=Ext.getCmp("serverViewport");if(h){d.doDeleteAction(h)}}}]}];var b=this.paging?_app.contextPath+"/client/system/jsonPagedServers.action":_app.contextPath+"/client/system/jsonListedServers.action";var a=this.rootProperty?this.rootProperty:(this.paging?"data.result":"data");this.store=new Ext.data.JsonStore({url:b,root:a,idProperty:"id",totalProperty:"totalCount",baseParams:{"page.limit":this.pageSize},autoLoad:this.autoLoading,fields:["id","title","serverId","currPath","ipAddress","port","type","typeText"]});if(this.paging){this.bbar=new Jinpeng.widget.PagingToolbar({pageSize:this.pageSize,store:this.store})}Jinpeng.system.server.ServerGrid.superclass.constructor.apply(this,arguments)}});Jinpeng.system.server.ToolBar=Ext.extend(Ext.Toolbar,{createHandler:Ext.emptyFn,updateHandler:Ext.emptyFn,deleteHandler:Ext.emptyFn,constructor:function(b){var a=this;Ext.apply(this,b);this.items=[{text:"新增",minWidth:80,handler:function(c,d){a.createHandler(a)}},{text:"修改",minWidth:80,handler:function(c,d){a.updateHandler(a)}},{text:"删除",minWidth:80,handler:function(c,d){a.deleteHandler(a)}}];Jinpeng.system.server.ToolBar.superclass.constructor.apply(this,arguments)}});Jinpeng.system.server.ModificationWindow=Ext.extend(Jinpeng.widget.GeneralWindow,{width:350,height:250,padding:10,constructor:function(a){Ext.apply(this,a);var b=this;this.readyStores=[];this.fp=new top.Ext.form.FormPanel({region:"center",padding:"10",border:false,url:this.url,defaults:{xtype:"textfield"},items:[{xtype:"hidden",name:"id"},{fieldLabel:"服务编号",name:"serverId",anchor:"-30",allowBlank:false,blankText:"请填写服务编号",regex:/^\d*$/,regexText:"服务编号必须为数字形式"},{fieldLabel:"服务名称",name:"title",anchor:"-30",allowBlank:false,regex:/^.{2,100}$/,regexText:"服务名称限定为2~100个字符"},{xtype:"tcombo",fieldLabel:"服务类型",name:"type",anchor:"-30",allowBlank:false,mode:"local",triggerAction:"all",valueField:"id",displayField:"text",blankText:"请选择服务类型",emptyText:"请选择",store:new Ext.data.JsonStore({itemId:"serverType",url:_app.contextPath+"/client/system/jsonDictsInCombo.action",baseParams:{code:"SERVER_TYPE"},root:"data",idProperty:"id",totalProperty:"totalCount",autoLoad:true,fields:["id","text"]})},{fieldLabel:"IP地址",name:"ipAddress",anchor:"-30",allowBlank:false,blankText:"请填写IP地址",regex:/((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)/,regexText:"IP地址格式错误"},{fieldLabel:"端口",name:"port",anchor:"-30",allowBlank:true,regex:/^\d*$/,regexText:"端口必须为数字形式"},{fieldLabel:"所在目录",name:"currPath",anchor:"-30",allowBlank:true}]});this.items=[this.fp];this.buttons=[{text:"确定",handler:this.okHandler},{text:"关闭",handler:this.closeHandler}];Jinpeng.system.server.ModificationWindow.superclass.constructor.apply(this,arguments)},okHandler:function(d,a){var h="server.";var j=d.ownerCt.ownerCt;var e=j.fp;var c=e.getForm();if(e.url&&c.isValid()){var b=c.getFieldValues();var f={};for(var g in b){if(g!="-"){f[h+g]=b[g]}}Ext.Ajax.request({url:e.url,params:f,success:function(i,k){json=i.responseText;var m=i.responseData||Ext.decode(json);if(m&&m.success){Ext.getCmp("serverViewport").refresh();try{if(!b.id){top.broadcastEvent("addServerEvent",function(){},{serverId:m.data})}else{top.broadcastEvent("modifyServerEvent",function(){},{serverId:m.data})}}catch(l){}if(j){j.close()}}}})}},closeHandler:function(a,c){var b=a.ownerCt.ownerCt;b.close()},init:function(b){var a=this.fp;if(b.id){a.getForm().load({url:_app.contextPath+"/client/system/jsonLoadServer.action",params:{id:b.id},success:function(c,d){}})}}});Jinpeng.system.server.ServerViewport=Ext.extend(Ext.Viewport,{id:"serverViewport",layout:"fit",constructor:function(a){Ext.apply(this,a);this.toolbar=new Jinpeng.system.server.ToolBar({region:"north",defaults:{cls:"small_btn",style:"margin-left:5px"},autoHeight:true,height:100,createHandler:function(b){var c=Ext.getCmp("serverViewport");c.doCreateAction()},updateHandler:function(b){var c=Ext.getCmp("serverViewport");c.doUpdateAction()},deleteHandler:function(b){var c=Ext.getCmp("serverViewport");c.doDeleteAction()}});this.grid=new Jinpeng.system.server.ServerGrid({region:"center",border:false});this.items=[{border:false,layout:"border",items:[this.toolbar,this.grid]}];Jinpeng.system.server.ServerViewport.superclass.constructor.apply(this,arguments)},refresh:function(){this.grid.getStore().reload()},doCreateAction:function(){var a=new Jinpeng.system.server.ModificationWindow({title:"新增服务",url:_app.contextPath+"/client/system/jsonCreateServer.action"});a.show()},doUpdateAction:function(c){if(!c){var a=this.grid.getSelectionModel().getSelections();if(a.length>1){top.Ext.Msg.show({title:"提示",msg:"只能选择一条记录",buttons:Ext.MessageBox.OK});return}else{c=a.length==1?a[0].get("id"):null}}if(c){var b=new Jinpeng.system.server.ModificationWindow({title:"修改服务",url:_app.contextPath+"/client/system/jsonUpdateServer.action"});b.on("allstoreready",function(){b.init({id:c})});b.show()}else{top.Ext.Msg.show({title:"提示",msg:"请选择需要修改的记录",buttons:Ext.MessageBox.OK})}},doDeleteAction:function(c){var b=[];if(!c){var a=this.grid.getSelectionModel().getSelections();if(a){Ext.each(a,function(d){b.push(d.get("id"))})}}else{b.push(c)}if(b&&b.length>0){top.Ext.MessageBox.show({buttons:{ok:"确认",cancel:"取消"},title:"确认删除",msg:"你是否确定要删除该服务？",modal:false,fn:function(e,f,d){if(e=="ok"){Ext.Ajax.request({url:_app.contextPath+"/client/system/jsonDeleteServer.action",params:{ids:b},success:function(g,h){json=g.responseText;var j=g.responseData||Ext.decode(json);if(j&&j.success){Ext.getCmp("serverViewport").refresh();try{top.broadcastEvent("delServerEvent",function(){},{serverId:c})}catch(i){Ext.debug(i)}}}})}}})}else{top.Ext.Msg.show({title:"提示",msg:"请选择需要删除的记录",buttons:Ext.MessageBox.OK})}}});Ext.ns("Jinpeng.system.user");Ext.ns("Jinpeng.system.permgroup");registerStartup("user",function(){new Jinpeng.system.user.UserViewPort({cls:"system_mod"})});Jinpeng.system.user.UserViewPort=Ext.extend(Ext.Viewport,{id:"userViewport",layout:"fit",constructor:function(b){var a=this;Ext.apply(this,b);this.tree=new Jinpeng.widget.OrganizationTree({region:"west",title:"组织结构",width:200,margins:"0 5 0 0",autoLoading:true,showCheckbox:false});this.tree.getSelectionModel().on("selectionchange",function(e,d){var c=a.tree.getSelectedNodeId();if(d){a.grid.reload()}});this.searchbar=new Ext.Panel({border:false,layout:"ttable",cls:"filter_area",labelWidth:70,labelAlign:"right",items:[{xtype:"textfield",fieldLabel:"人员编号",name:"userCode",width:156},{xtype:"textfield",fieldLabel:"人员名称",name:"userName",width:156},{style:"margin-left:5px",xtype:"button",minWidth:80,text:"查询",cls:"small_btn",handler:function(c,d){a.grid.reload()}}],getUserCode:function(){return this.find("name","userCode").first().getValue()},getUserName:function(){return this.find("name","userName").first().getValue()}});this.toolbar=new Ext.Toolbar({border:false,cls:"toolbar",defaults:{minWidth:80},items:[{xtype:"button",text:"新增",cls:"small_btn",handler:function(c,d){a.doCreateAction()}},{style:"margin-left:5px",xtype:"button",text:"修改",cls:"small_btn",handler:function(c,d){a.doUpdateAction()}},{style:"margin-left:5px",xtype:"button",text:"删除",cls:"small_btn",handler:function(c,d){a.doDeleteAction()}},{style:"margin-left:5px",xtype:"button",text:"导入",cls:"small_btn",handler:function(c,d){a.doImportAction()}},{style:"margin-left:5px",xtype:"button",text:"导出",cls:"small_btn",handler:function(c,d){a.doExportAction(true)}},{style:"margin-left:5px",xtype:"button",text:"导出选中",cls:"small_btn",handler:function(c,d){a.doExportAction(false)}}]});this.grid=new Jinpeng.system.user.UserGrid({region:"center",height:300});this.main=new Ext.Panel({layout:"border",border:false,cls:"system_mod",items:[this.tree,{region:"center",border:false,layout:"border",items:[{region:"north",border:false,autoHeight:true,items:[this.searchbar,this.toolbar]},this.grid]}]});this.items=[this.main];Jinpeng.system.user.UserViewPort.superclass.constructor.apply(this,arguments)},refresh:function(){this.tree.reload()},doCreateAction:function(){var b=this.tree.getSelectedNodeId();var a=new Jinpeng.system.user.UserModificationWindow({cls:"system_mod",title:"新增用户",callback:function(d){if(d=="ok"){var c=Ext.getCmp("userViewport");c.refresh()}}});a.init({orgId:b});a.show()},doUpdateAction:function(d){if(!d){var a=this.grid.getSelectionModel().getSelections();if(a.length>1){top.Ext.Msg.show({title:"提示",msg:"只能选择一条记录",buttons:Ext.MessageBox.OK});return}else{d=a.length==1?a[0].get("id"):null}}if(d){var c=this.tree.getSelectedNodeId();var b=new Jinpeng.system.user.UserModificationWindow({cls:"system_mod",title:"修改用户",callback:function(f){if(f=="ok"){var e=Ext.getCmp("userViewport");e.refresh()}}});b.init({id:d,orgId:c});b.show()}else{top.Ext.Msg.show({title:"提示",msg:"请选择需要修改的记录",buttons:Ext.MessageBox.OK})}},doDeleteAction:function(c){var b=[];if(!c){var a=this.grid.getSelectionModel().getSelections();if(a){Ext.each(a,function(d){b.push(d.get("id"))})}}else{b.push(c)}if(b&&b.length>0){top.Ext.MessageBox.show({buttons:{ok:"确认",cancel:"取消"},title:"确认删除",msg:"你是否确定要删除该用户？",modal:false,fn:function(e,f,d){if(e=="ok"){Ext.Ajax.request({url:_app.contextPath+"/client/system/deleteUser.action",params:{ids:b},success:function(h,i){json=h.responseText;var k=h.responseData||Ext.decode(json);if(k&&k.success){var g=Ext.getCmp("userViewport");g.refresh();try{top.broadcastEvent("delUserEvent",function(){},{userId:c})}catch(j){}}}})}}})}else{top.Ext.Msg.show({title:"提示",msg:"请选择需要删除的记录",buttons:Ext.MessageBox.OK})}},doImportAction:function(){new Jinpeng.widget.GeneralWindow({title:"请选择上传文件",layout:"border",width:350,height:100,modal:false,items:{itemId:"form",xtype:"form",region:"center",fileUpload:true,border:false,labelWidth:65,labelAlign:"right",padding:5,items:[{fieldLabel:"上传文件",xtype:"fileuploadfield",name:"file",anchor:"-30",emptyText:"请选择一个文件",allowBlank:false,buttonText:"选择文件"}]},buttons:[{text:"确定",handler:function(a,d){var c=a.ownerCt.ownerCt;var b=c.getComponent("form").getForm();if(b.isValid()){b.submit({url:_app.contextPath+"/client/system/importUser.action",success:function(f,g){c.close();var e=Ext.getCmp("userViewport");e.refresh()}})}}},{text:"取消",handler:function(a,b){a.ownerCt.ownerCt.close()}}]}).show()},doExportAction:function(j){var c="";if(j){var k=this.searchbar.getUserName();var l=this.searchbar.getUserCode();var d=this.tree.getSelectedNodeId();var f=[];if(k&&k!=""){f[f.length]="user.userName="+k}if(l&&l!=""){f[f.length]="user.userCode="+l}if(d&&d!=""){f[f.length]="orgId="+d}var h=f.join("&");c=_app.contextPath+"/client/system/exportAllUser.action"+(h==""?"":"?"+h)}else{var e=this.grid.getSelectionModel().getSelections();var b=[];if(e){for(var g=0;g<e.length;g++){b[b.length]=e[g].get("id")}}var a=b?b.join(","):"";c=_app.contextPath+"/client/system/exportGivenUser.action?idstr="+a}if(c!=""){window.open(c)}}});Jinpeng.system.user.UserModificationWindow=Ext.extend(Jinpeng.widget.GeneralWindow,{width:700,height:500,constructor:function(a){var b=this;Ext.apply(this,a);var c=new Ext.data.JsonStore({url:_app.contextPath+"/client/system/allOrgsInCombo.action",baseParams:this.baseParams,root:"data",idProperty:"id",totalProperty:"totalCount",autoLoad:false,fields:["id","text"]});this.fieldSet1=new top.Ext.form.FieldSet({xtype:"fieldset",title:"账号信息",border:true,layout:"ttable",labelWidth:90,layoutConfig:{columns:3,tableAttrs:{style:{width:"100%"}}},defaults:{xtype:"textfield",width:160},items:[{fieldLabel:"登录账号",name:"loginName",cellWidth:270,allowBlank:false,blankText:"请填写登录账号",emptyText:"请填写登录账号",regex:/^.{2,100}$/,regexText:"登录账号限定为2~100个字符"},{fieldLabel:"登录密码",name:"loginPass",cellWidth:270,inputType:"password",regex:/^.{2,32}$/,regexText:"登录密码限定为2~32个字符"},{cellWidth:70,width:60,autoHeight:true,xtype:"checkbox",name:"reuse",boxLabel:"复用"},{fieldLabel:"密码确认",name:"repassword",inputType:"password",anchor:"100%",validate:function(){var g=b.fp.getForm();var f=this.getValue();var e=g.findField("loginPass").getValue();var d=f==e;if(!d){this.markInvalid()}else{this.clearInvalid()}return d},invalidText:"两次输入的密码不一致"},{xtype:"tooltiptextfield",tooltip:{text:"只有勾选启用该功能才能生效！"},fieldLabel:"固定登录IP",name:"loginIP",regex:/^((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)$/,regexText:"固定登录IP格式错误"},{width:60,autoHeight:true,xtype:"checkbox",name:"enableLoginIP",boxLabel:"启用"}]});this.fieldSet2=new top.Ext.form.FieldSet({xtype:"fieldset",title:"基本信息",border:true,labelWidth:80,layout:"ttable",layoutConfig:{columns:3,tableAttrs:{style:{width:"100%"}}},defaults:{xtype:"textfield",width:160},items:[{fieldLabel:"人员名称",name:"realName",cellWidth:270,allowBlank:false,blankText:"请填写人员名称",emptyText:"请填写人员名称",regex:/^.{2,100}$/,regexText:"人员名称限定为2~100个字符"},{fieldLabel:"身份证号码",name:"identityCard",cellWidth:270,allowBlank:false,blankText:"请填写身份证号码",emptyText:"请填写身份证号码",regex:/^.{2,20}$/,regexText:"身份证号码限定为2~20个字符"},{cellWidth:70,width:60,xtype:"spacer"},{fieldLabel:"人员编号",name:"userCode",regex:/^.{2,32}$/,regexText:"人员编号限定为2~32个字符"},{fieldLabel:"单位编号",name:"unitCode",regex:/^.{0,100}$/,regexText:"单位编号限定为100个字符"},{width:60,xtype:"spacer"},{fieldLabel:"单位名称",name:"unitName",regex:/^.{0,100}$/,regexText:"单位名称限定为100个字符"},{fieldLabel:"联系电话",name:"phone",regex:/^.{0,100}$/,regexText:"联系电话限定为100个字符"},{width:60,xtype:"spacer"},{xtype:"tcombo",editable:false,triggerAction:"all",store:c,mode:"local",fieldLabel:"所属组织",name:"orgId",valueField:"id",displayField:"text",allowBlank:false,blankText:"请选择所属组织",emptyText:"请选择所属组织"},{xtype:"tcombo",editable:false,triggerAction:"all",store:new Ext.data.ArrayStore({fields:["id","text"],data:[[0,"失效"],[1,"在用"]]}),mode:"local",fieldLabel:"使用状态",name:"state",valueField:"id",displayField:"text",allowBlank:false,blankText:"请选择使用状态",emptyText:"请选择使用状态"}]});this.pgs=new Jinpeng.system.user.PermGroupTabPanel({region:"center"});this.fp=new top.Ext.form.FormPanel({xtype:"form",region:"center",border:false,items:[{name:"id",xtype:"hidden"},this.fieldSet1,this.fieldSet2,{xtype:"fieldset",anchor:"100% -250",title:"权限",border:true,layout:"border",items:[this.pgs]}]});this.buttons=[{text:"确定",handler:this.okHandler},{text:"关闭",handler:this.closeHandler}];this.items={region:"center",layout:"fit",border:false,padding:5,items:this.fp};Jinpeng.system.user.UserModificationWindow.superclass.constructor.apply(this,arguments)},init:function(b){var d=this;var c=d.fp.getForm();var e=c.findField("orgId");var f=b.id||null;var a=b.orgId||null;e.getStore().load({callback:function(h,g,i){if(f){c.load({url:_app.contextPath+"/client/system/loadUser.action",params:{id:f},success:function(j,l){var m=j.getFieldValues();j.findField("repassword").setValue(m.loginPass);j.findField("enableLoginIP").setValue(m.loginIP!=null&&m.loginIP.length>0);if(l&&l.result&&l.result.data){var k=l.result.data;d.pgs.init(k.fpgIds,k.opgIds)}}})}else{if(a){e.setValue(a)}d.pgs.init()}}})},okHandler:function(){var g="user.";var h=this.ownerCt.ownerCt;var d=h.fp;var c=d.getForm();if(c.isValid()){var b=c.getFieldValues();var e={};if(!b.enableLoginIP){b.loginIP=""}delete b.enableLoginIP;b.reuse=b.reuse?1:0;e.orgId=b.orgId;delete b.orgId;delete b.repassword;var j=h.pgs.getSelections();if(j[0]&&j[0].length>0){e.fpgIds=j[0]}if(j[1]&&j[1].length>0){e.opgIds=j[1]}for(var f in b){if(f!="-"){e[g+f]=b[f]}}var a=b.id?_app.contextPath+"/client/system/updateUser.action":_app.contextPath+"/client/system/createUser.action";Ext.Ajax.request({url:a,params:e,success:function(i,k){json=i.responseText;var m=i.responseData||Ext.decode(json);if(m&&m.success){if(h){h.close()}try{if(!b.id){top.broadcastEvent("addUserEvent",function(){},{userId:m.data})}else{top.broadcastEvent("modifyUserEvent",function(){},{userId:m.data})}}catch(l){}h.callback("ok")}}})}},closeHandler:function(){var a=this.ownerCt.ownerCt;if(a){a.close()}}});Jinpeng.system.user.UserGrid=Ext.extend(Jinpeng.widget.GeneralGrid,{paging:true,constructor:function(a){Ext.apply(this,a);this.store=new Ext.data.Store({pageSize:this.pageSize,remoteSort:true,autoLoad:this.autoLoading,url:_app.contextPath+"/client/system/userPage.action",reader:new Ext.data.JsonReader({fields:["id","userName","userCode","realName","loginName","orgName","state"],idProperty:"id",root:"result",totalProperty:"totalCount"}),listeners:{beforeload:function(c,d){var b=Ext.getCmp("userViewport");var f=b.searchbar.getUserName();var g=b.searchbar.getUserCode();var e=b.tree.getSelectedNodeId();if(!d.params){d.params={}}Ext.apply(d.params,{orgId:e,"user.userName":f,"user.userCode":g});Ext.applyIf(d.params,{"page.start":0,"page.limit":this.pageSize})}}});this.columns=[{header:"用户名称",dataIndex:"realName",width:100},{header:"用户别名",dataIndex:"userName",width:100},{header:"编号",dataIndex:"userCode",width:100},{header:"所属部门",dataIndex:"orgName",width:100},{header:"账号",dataIndex:"loginName",width:100},{header:"描述",dataIndex:"remark",width:100},{header:"在线状态",dataIndex:"state",width:100,renderer:function(b){return b==0?"离线":"在线"}},{header:"操作",xtype:"actioncolumn",width:100,items:[{icon:_app.contextPath+"/content/themes/client/blue/images/system/edit.gif",tooltip:"修改",handler:function(d,g,c){var e=d.getStore().getAt(g);var f=e&&e.get("id")||null;var b=Ext.getCmp("userViewport");b.doUpdateAction(f)}},{icon:_app.contextPath+"/content/themes/client/blue/images/system/delete.gif",tooltip:"删除",handler:function(d,g,c){var e=d.getStore().getAt(g);var f=e&&e.get("id")||null;var b=Ext.getCmp("userViewport");b.doDeleteAction(f)}}]}];Jinpeng.system.user.UserGrid.superclass.constructor.apply(this,arguments)}});Jinpeng.system.user.PermGroupTabPanel=Ext.extend(top.Ext.TabPanel,{activeTab:0,border:false,constructor:function(a){Ext.apply(this,a);this.funcTab=new Jinpeng.system.user.PermGroupGrid({title:"功能权限集",url:_app.contextPath+"/client/system/jsonListedRoles.action"});this.orgTab=new Jinpeng.system.user.PermGroupGrid({title:"组织权限集",url:_app.contextPath+"/client/system/jsonListedOrgRoles.action"});this.items=[this.funcTab,this.orgTab];Jinpeng.system.user.PermGroupTabPanel.superclass.constructor.apply(this,arguments)},init:function(a,b){this.funcTab.init(a);this.orgTab.init(b)},reload:function(){this.funcTab.reload();this.orgTab.reload()},getSelections:function(){var b=this.funcTab.getSelectionIds();var a=this.orgTab.getSelectionIds();return[b,a]}});Jinpeng.system.user.PermGroupGrid=Ext.extend(top.Jinpeng.widget.GeneralGrid,{url:null,constructor:function(a){Ext.apply(this,a);this.store=new top.Ext.data.Store({pageSize:this.pageSize,remoteSort:true,autoLoad:this.autoLoading,url:this.url,reader:new top.Ext.data.JsonReader({fields:["id","name","remark"],idProperty:"id",root:"data",totalProperty:"totalCount"})});this.sm=new top.Ext.grid.CheckboxSelectionModel({});this.columns=[{header:"名称",dataIndex:"name",width:100},{header:"说明",dataIndex:"remark",width:100}];Jinpeng.system.user.PermGroupGrid.superclass.constructor.apply(this,arguments)},init:function(a){if(this.rendered){this.reload(a)}else{this.selectionIds=a;this.on("render",function(b){var c=arguments.callee;b.init(this.selectionIds);b.removeListener("render",c);delete this.selectionIds})}},getSelectionIds:function(){if(this.rendered){var a=this.getSelectionModel().getSelections();var c=[];for(var b=0;b<a.length;b++){c.push(a[b].get("id"))}return c}else{return this.selectionIds}},reload:function(d){if(!d){d=[]}var c=this;var b=this.getStore();var a=this;b.reload({callback:function(e,k,m){if(e&&e.length>0){var j=[];for(var g=0;g<e.length;g++){var h=e[g].get("id");var l=false;for(var f=0;f<d.length;f++){if(d[f]==h){l=true;break}}if(l){j.push(e[g])}}c.getSelectionModel().selectRecords(j)}}})}});